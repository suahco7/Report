<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Cards - EduResult</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7c7cc; 
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1aa; 
        }
    </style>
    <!-- Favicons -->
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="EduResult" />
    <link rel="manifest" href="site.webmanifest" />
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Header -->
    <header id="main-header" class="w-full max-w-7xl flex justify-between items-center mb-6 transition-all duration-300">
        <div class="flex items-center gap-3 text-indigo-600">
            <i class="fa-solid fa-graduation-cap text-3xl md:text-4xl"></i>
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">Suahco4<span class="text-indigo-600">Portal</span></h1>
        </div>
        <div>
            <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Instructor Access</span>
        </div>
    </header>

    <!-- Main Container -->
    <main class="w-full max-w-md md:max-w-7xl bg-white rounded-2xl shadow-xl overflow-hidden relative min-h-[500px] flex flex-col transition-all duration-300 ease-in-out">
        
        <!-- ==================== ADMIN LOGIN SECTION ==================== -->
        <div id="admin-login-section" class="w-full flex-1 flex flex-col items-center justify-center p-8 fade-in">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-100 text-indigo-600 mb-4">
                        <i class="fa-solid fa-user-shield text-3xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Instructor Access</h2>
                    <p class="text-gray-500 mt-2">Login to manage student grades.</p>
                </div>

                <form id="admin-login-form" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="admin-email" class="block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-indigo-500 focus:border-indigo-500 py-3 px-4 text-gray-900" placeholder="admin@example.com" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="admin-password" class="block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-indigo-500 focus:border-indigo-500 py-3 px-4 text-gray-900" placeholder="admin123" required>
                    </div>

                    <div class="flex justify-end">
                        <button type="button" onclick="openForgotModal()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium cursor-pointer">Forgot Password?</button>
                    </div>

                    <div id="admin-error-msg" class="hidden bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-center gap-2">
                        <i class="fa-solid fa-circle-exclamation"></i>
                        <span id="login-error-text">Invalid Credentials.</span>
                    </div>

                    <button type="submit" id="admin-login-btn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors cursor-pointer disabled:opacity-70 disabled:cursor-not-allowed">
                        <i id="login-spinner" class="fa-solid fa-circle-notch fa-spin hidden mr-2"></i>
                        <span>Login as Instructor</span>
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <a href="index.html" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                        &larr; Go to Student Portal
                    </a>
                </div>
            </div>
        </div>

        <!-- ==================== ADMIN DASHBOARD SECTION ==================== -->
        <div id="admin-dashboard-section" class="hidden w-full h-full flex flex-col md:flex-row fade-in overflow-hidden bg-gray-50">
            
            <!-- Sidebar -->
            <aside class="w-full md:w-64 bg-gray-900 text-gray-300 flex flex-col flex-shrink-0">
                <div class="p-4 md:p-6 flex justify-between items-center text-white font-bold text-xl border-b border-gray-800">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-graduation-cap"></i> Suahco4
                    </div>
                    <button onclick="document.getElementById('sidebar-content').classList.toggle('hidden')" class="md:hidden text-gray-400 hover:text-white cursor-pointer">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                </div>
                <div id="sidebar-content" class="hidden md:flex flex-col flex-1 overflow-hidden h-full">
                <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                    <button class="w-full flex items-center gap-3 px-4 py-3 bg-indigo-600 text-white rounded-lg transition-colors text-left shadow-lg shadow-indigo-900/20">
                        <i class="fa-solid fa-chart-pie w-5 text-center"></i> <span class="font-medium">Overview</span>
                    </button>
                    <button onclick="document.getElementById('student-search').focus()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-800 hover:text-white rounded-lg transition-colors text-left">
                        <i class="fa-solid fa-users w-5 text-center"></i> <span class="font-medium">Students</span>
                    </button>
                    <button onclick="openEditModal()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-800 hover:text-white rounded-lg transition-colors text-left">
                        <i class="fa-solid fa-user-plus w-5 text-center"></i> <span class="font-medium">Add Student</span>
                    </button>
                </nav>
                <div class="p-4 border-t border-gray-800 bg-gray-900/50">
                    <div class="mb-4">
                        <label class="text-xs font-bold text-gray-500 uppercase block mb-2">Global Settings</label>
                        <div class="space-y-2">
                            <input type="text" id="admin-school-input" class="bg-gray-800 border border-gray-700 text-white text-xs rounded px-3 py-2 w-full focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" placeholder="School Name">
                            
                            <div class="flex gap-2">
                                <input type="text" id="admin-year-input" class="bg-gray-800 border border-gray-700 text-white text-xs rounded px-3 py-2 w-full focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" placeholder="Year (e.g. 2023-2024)">
                                <button onclick="updateSettings()" class="text-xs bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-500 transition-colors cursor-pointer" title="Save Settings"><i class="fa-solid fa-check"></i></button>
                            </div>
                        </div>
                    </div>
                    <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-red-900/20 hover:text-red-400 rounded-lg transition-colors text-left group">
                        <i class="fa-solid fa-right-from-bracket w-5 text-center group-hover:text-red-400 transition-colors"></i> <span class="font-medium">Logout</span>
                    </button>
                </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col h-full overflow-hidden relative">
                <!-- Top Bar -->
                <div class="bg-white border-b border-gray-200 px-4 md:px-8 py-4 flex justify-between items-center sticky top-0 z-10">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                        <p class="text-gray-500 text-sm">Welcome back, Instructor</p>
                    </div>
                    <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 shadow-sm">
                        <i class="fa-solid fa-user-tie text-lg"></i>
                    </div>
                </div>

                <!-- Scrollable Content -->
                <div class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <div class="text-blue-500 text-sm font-medium">Total Students</div>
                    <div id="admin-total-students" class="text-2xl font-bold text-gray-800">0</div>
                </div>
                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                    <div class="text-green-500 text-sm font-medium">Class Average</div>
                    <div id="admin-class-avg" class="text-2xl font-bold text-gray-800">0%</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                    <div class="text-orange-500 text-sm font-medium">Pass / Fail</div>
                    <div class="text-2xl font-bold text-gray-800">
                        <span id="admin-pass-count" class="text-green-600">0</span> / 
                        <span id="admin-fail-count" class="text-red-600">0</span>
                    </div>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
                    <div class="text-purple-500 text-sm font-medium">Top Performer</div>
                    <div id="admin-top-student" class="text-xl font-bold text-gray-800 text-truncate">--</div>
                </div>
            </div>

            <!-- Top Performers Section -->
            <div class="bg-white border border-gray-200 rounded-xl p-6 mb-8 shadow-sm">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-trophy text-yellow-500"></i>
                        Top 5 Performers
                    </h3>
                    <div class="flex items-center gap-2 mt-2 md:mt-0">
                        <label class="text-sm text-gray-500 font-medium">Select Class:</label>
                        <select id="top-class-filter" class="text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" onchange="renderTopList()">
                            <!-- Options injected by JS -->
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4" id="top-performers-list">
                    <!-- Top 5 Cards injected by JS -->
                </div>
            </div>

            <div class="bg-white border border-gray-200 rounded-xl overflow-hidden flex-1 flex flex-col">
                <div class="p-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-center gap-4 bg-gray-50">
                    <h3 class="font-bold text-gray-700">Registered Students</h3>
                    <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><i class="fa-solid fa-magnifying-glass"></i></span>
                            <input type="text" id="student-search" onkeyup="filterStudentList()" placeholder="Search Name or ID..." class="pl-9 text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 bg-white w-full sm:w-64">
                        </div>
                        <div class="relative">
                            <button onclick="document.getElementById('action-menu').classList.toggle('hidden')" class="text-sm bg-white hover:bg-gray-50 text-gray-700 px-3 py-2 rounded-lg font-medium transition-colors cursor-pointer border border-gray-300 whitespace-nowrap shadow-sm flex items-center gap-2">
                                <i class="fa-solid fa-ellipsis"></i> <span class="hidden sm:inline">Actions</span>
                            </button>
                            <div id="action-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200 py-1">
                                <button onclick="exportToCSV(); document.getElementById('action-menu').classList.add('hidden')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                                    <i class="fa-solid fa-file-csv text-green-600"></i> Export CSV
                                </button>
                                <button onclick="bulkDelete(); document.getElementById('action-menu').classList.add('hidden')" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 flex items-center gap-2">
                                    <i class="fa-solid fa-trash-can"></i> Bulk Delete
                                </button>
                                <button id="toggle-archived-btn" onclick="toggleArchivedView(); document.getElementById('action-menu').classList.add('hidden')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2">
                                    <i class="fa-solid fa-box-archive text-gray-500"></i> Show Archived
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="class-filter" onchange="filterStudentList()" class="text-sm border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2 bg-white min-w-[120px]">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                                    <input type="checkbox" id="select-all-checkbox" onclick="toggleSelectAll()" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Updated</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-student-list" class="bg-white divide-y divide-gray-200">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                    <span class="text-sm text-gray-600" id="pagination-info">Page 1 of 1</span>
                    <div class="flex gap-2">
                        <button onclick="changePage(-1)" id="prev-btn" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer">Previous</button>
                        <button onclick="changePage(1)" id="next-btn" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer">Next</button>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>

        <!-- ==================== ADMIN EDIT/ADD MODAL ==================== -->
        <div id="admin-edit-section" class="hidden fixed inset-0 bg-white/95 z-50 p-2 md:p-8 overflow-y-auto fade-in">
            <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl border border-gray-200 p-6">
                <div class="flex justify-between items-start mb-6 border-b border-gray-100 pb-4">
                    <div>
                        <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Edit Student Grades</h2>
                        <p id="modal-last-updated" class="text-xs text-gray-500 mt-1"></p>
                    </div>
                    <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-700 transition-colors cursor-pointer">
                        <i class="fa-solid fa-xmark text-2xl"></i>
                    </button>
                </div>

                <form id="edit-student-form" class="space-y-6">
                    <input type="hidden" id="edit-mode" value="add"> 
                    
                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4 bg-gray-50 p-4 rounded-lg">
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label>
                            <input type="text" id="edit-name" class="block w-full rounded border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2 px-3" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ID</label>
                            <div class="flex">
                                <input type="text" id="edit-id" class="block w-full rounded-l border border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2 px-3 bg-gray-100" readonly required>
                                <button type="button" onclick="copyToClipboard('edit-id', this)" class="relative bg-gray-50 hover:bg-gray-100 text-gray-600 px-3 py-2 border border-l-0 border-gray-300 text-xs font-bold uppercase transition-colors" title="Copy ID">
                                    <i class="fa-regular fa-copy"></i>
                                    <span class="tooltip-text absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 transition-opacity duration-200 pointer-events-none shadow-lg whitespace-nowrap z-10">Copied!</span>
                                </button>
                                <button type="button" onclick="generateNewId()" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-2 rounded-r border border-l-0 border-indigo-200 text-xs font-bold uppercase transition-colors" title="Generate Unique ID">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Class</label>
                            <input type="text" id="edit-class" class="block w-full rounded border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2 px-3" placeholder="e.g. 10A" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Roll</label>
                            <input type="text" id="edit-roll" class="block w-full rounded border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2 px-3" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Year</label>
                            <input type="text" id="edit-year" class="block w-full rounded border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2 px-3" placeholder="2023-2024">
                        </div>
                        <div class="sm:col-span-2 md:col-span-5">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Principal's Comment</label>
                            <textarea id="edit-principal-comment" rows="2" class="block w-full rounded border-gray-300 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm py-2 px-3" placeholder="Overall remarks..."></textarea>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800">Subjects & Period Grades</h3>
                            <button type="button" onclick="addSubjectRow()" class="text-sm bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full font-medium hover:bg-indigo-100 transition-colors cursor-pointer">
                                + Add Subject
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase min-w-[150px]">Subject Name</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">1st</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">2nd</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">3rd</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-indigo-600 uppercase bg-indigo-50">1st Sem</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase bg-gray-50">Avg</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase border-l border-gray-200">4th</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">5th</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase">6th</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-indigo-600 uppercase bg-indigo-50">2nd Sem</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-600 uppercase bg-gray-50">Avg</th>
                                        <th class="px-3 py-2 text-left text-xs font-bold text-gray-500 uppercase min-w-[150px]">Comment</th>
                                        <th class="px-2 py-2"></th>
                                    </tr>
                                </thead>
                                <tbody id="subjects-container" class="bg-white divide-y divide-gray-200">
                                    <!-- Subject rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-6 border-t border-gray-200">
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 cursor-pointer">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium shadow-sm transition-colors cursor-pointer">Save Results</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ==================== FORGOT PASSWORD MODAL ==================== -->
        <div id="forgot-password-modal" class="hidden fixed inset-0 bg-gray-600/50 overflow-y-auto h-full w-full z-50 fade-in flex items-center justify-center p-4">
            <div class="relative p-5 border w-96 shadow-lg rounded-xl bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
                        <i class="fa-solid fa-key text-indigo-600"></i>
                    </div>
                    <h3 class="text-lg leading-6 font-bold text-gray-900">Reset Password</h3>
                    <div class="mt-2 px-2 py-3">
                        <p class="text-sm text-gray-500 mb-4">Enter your email address and we'll send you a link to reset your password.</p>
                        <input type="email" id="reset-email" class="block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-indigo-500 focus:border-indigo-500 py-2 px-3 text-gray-900" placeholder="admin@example.com">
                        <p id="reset-msg" class="text-xs mt-2 hidden"></p>
                    </div>
                    <div class="items-center px-2 py-3 space-y-3">
                        <button id="send-reset-btn" onclick="sendResetEmail()" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-lg w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-colors cursor-pointer">Send Reset Link</button>
                        <button onclick="closeForgotModal()" class="px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-lg w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-colors cursor-pointer">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== CONFIRMATION MODAL ==================== -->
        <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-600/50 overflow-y-auto h-full w-full z-50 fade-in flex items-center justify-center p-4">
            <div class="relative p-5 border w-96 shadow-lg rounded-xl bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                        <i class="fa-solid fa-triangle-exclamation text-yellow-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg leading-6 font-bold text-gray-900" id="confirm-title">Confirm Action</h3>
                    <div class="mt-2 px-2 py-3">
                        <p class="text-sm text-gray-500" id="confirm-message">Are you sure?</p>
                    </div>
                    <div class="flex justify-center gap-3 mt-4">
                        <button id="confirm-cancel-btn" onclick="closeConfirmModal()" class="px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-lg shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-colors cursor-pointer">Cancel</button>
                        <button id="confirm-action-btn" onclick="executeConfirmAction()" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors cursor-pointer flex items-center justify-center">
                            <i id="confirm-spinner" class="fa-solid fa-circle-notch fa-spin hidden mr-2"></i>
                            <span id="confirm-btn-text">Confirm</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TOAST CONTAINER ==================== -->
        <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>

    </main>

    <script>
        // ================= STATE MANAGEMENT =================
        let students = [];
        let academicYear = "2025-2026";
        let schoolName = "Emmanuel Suah Academy";
        let currentFilteredStudents = [];
        let selectedStudentIds = new Set();
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentEditId = null;
        let currentUserUid = null;
        const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:3000'
            : 'https://progressreport-7jlm.onrender.com';
        // console.log('API_BASE_URL:', API_BASE_URL);
        const API_URL = `${API_BASE_URL}/api/students`;

        // DOM Elements
        const mainContainer = document.querySelector('main');
        const adminLoginForm = document.getElementById('admin-login-form');
        const editStudentForm = document.getElementById('edit-student-form');
        const adminErrorMsg = document.getElementById('admin-error-msg');

        // ================= FIREBASE SETUP =================
        let auth;

        async function initializeFirebase() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/config/firebase`);
                if (!response.ok) throw new Error('Failed to load Firebase configuration');
                const firebaseConfig = await response.json();

                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();

                // Auth State Listener
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        // console.log('Firebase Notification: User signed in', user.uid);
                        // Log login if not already logged in this session
                        if (!sessionStorage.getItem('session_active')) {
                            logActivity('LOGIN', 'Instructor logged into dashboard');
                            sessionStorage.setItem('session_active', 'true');
                        }
                        currentUserUid = user.uid;
                        showSection('admin-dashboard-section');
                        fetchSettings();
                    } else {
                        // console.log('Firebase Notification: User signed out');
                        currentUserUid = null;
                        showSection('admin-login-section');
                    }
                });
            } catch (error) {
                // console.error('Firebase Initialization Error:', error);
                showToast('Failed to initialize application. Please check configuration.', 'error');
            }
        }

        // ================= LOGGING HELPER =================
        async function logActivity(action, details) {
            try {
                if (!auth || !auth.currentUser) return;
                const token = await auth.currentUser.getIdToken();
                await fetch(`${API_BASE_URL}/api/activity`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ action, details })
                });
            } catch (e) { /* console.error("Logging failed", e); */ }
        }

        initializeFirebase();

        // ================= API INTEGRATION =================
        function apiToApp(student) {
            // Convert backend schema to frontend structure
            // Backend: grades array of objects { subject: "Math", p1: 80, ... }
            // Frontend: subjects array of objects { name: "Math", p1: 80, ... }
            const subjects = (student.grades || []).map(g => {
                const s = { ...g, name: g.subject };
                delete s.subject;
                return s;
            });

            return {
                id: student._id,
                name: student.name,
                class: student.className || '',
                roll: student.rollNumber || '',
                year: student.academicYear || '',
                principalComment: student.principalComment || '',
                isArchived: student.isArchived || false,
                updatedAt: student.updatedAt,
                subjects: subjects
            };
        }

        function appToApi(student) {
            // Convert frontend structure to backend schema
            const grades = student.subjects.map(s => {
                const g = { ...s, subject: s.name };
                delete g.name;
                return g;
            });

            return {
                id: student.id,
                name: student.name,
                className: student.class,
                rollNumber: student.roll,
                academicYear: student.year,
                principalComment: student.principalComment,
                isArchived: student.isArchived,
                sponsorId: currentUserUid,
                grades: grades
            };
        }

        async function fetchStudents() {
            try {
                if (!auth || !auth.currentUser) return;
                const token = await auth.currentUser.getIdToken();
                
                const res = await fetch(API_URL, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error('Failed to fetch');
                const data = await res.json();
                students = data.map(apiToApp);
                updateAdminDashboard();

                // Check URL params after fetching to auto-open modal
                const urlParams = new URLSearchParams(window.location.search);
                const studentId = urlParams.get('studentId');
                if (studentId) {
                    const student = students.find(s => s.id === studentId);
                    if(student) openEditModal(studentId);
                }
            } catch (e) {
                // console.error("Error fetching students:", e);
                showToast("Failed to load student data.", 'error');
            }
        }

        async function saveStudentApi(studentData, isEdit) {
            const payload = appToApi(studentData);
            try {
                if (!auth || !auth.currentUser) throw new Error("Not authenticated");
                const token = await auth.currentUser.getIdToken();

                const url = isEdit ? `${API_URL}/${studentData.id}` : API_URL;
                const method = isEdit ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message || 'Save failed');
                }
                
                await fetchStudents(); // Refresh list
                closeEditModal();
                showToast('Student saved successfully!');
            } catch (e) {
                // console.error("Error saving student:", e);
                showToast("Error saving student: " + e.message, 'error');
            }
        }

        async function deleteStudentApi(id, skipRefresh = false) {
            try {
                if (!auth || !auth.currentUser) throw new Error("Not authenticated");
                const token = await auth.currentUser.getIdToken();

                const res = await fetch(`${API_URL}/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Delete failed');
                if (!skipRefresh) {
                    await fetchStudents();
                    showToast('Student deleted successfully!');
                }
            } catch (e) {
                // console.error("Error deleting student:", e);
                showToast("Failed to delete student.", 'error');
            }
        }

        // ================= FORGOT PASSWORD LOGIC =================
        function openForgotModal() {
            document.getElementById('forgot-password-modal').classList.remove('hidden');
            document.getElementById('reset-msg').classList.add('hidden');
            // Pre-fill email if user typed it in login form
            const loginEmail = document.getElementById('admin-email').value;
            if(loginEmail) document.getElementById('reset-email').value = loginEmail;
        }

        function closeForgotModal() {
            document.getElementById('forgot-password-modal').classList.add('hidden');
        }

        function sendResetEmail() {
            const email = document.getElementById('reset-email').value;
            const msgEl = document.getElementById('reset-msg');
            const btn = document.getElementById('send-reset-btn');

            if (!auth) {
                msgEl.textContent = "System initializing, please wait...";
                msgEl.className = "text-xs mt-2 text-red-600 block";
                msgEl.classList.remove('hidden');
                return;
            }

            if(!email) {
                msgEl.textContent = "Please enter an email address.";
                msgEl.className = "text-xs mt-2 text-red-600 block";
                msgEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            const originalText = btn.textContent;
            btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Sending...';

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    // console.log('Firebase Notification: Password reset email sent.');
                    msgEl.textContent = "Reset link sent! Check your inbox.";
                    msgEl.className = "text-xs mt-2 text-green-600 block";
                    msgEl.classList.remove('hidden');
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Sent';
                    setTimeout(() => {
                        closeForgotModal();
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }, 2000);
                })
                .catch((error) => {
                    // console.error('Firebase Notification [Reset Error]:', error.message);
                    msgEl.textContent = error.message;
                    msgEl.className = "text-xs mt-2 text-red-600 block";
                    msgEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
        }

        // ================= CONFIRMATION MODAL LOGIC =================
        let onConfirmAction = null;

        function openConfirmModal(title, message, callback, isDestructive = false) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            onConfirmAction = callback;
            
            const confirmBtn = document.getElementById('confirm-action-btn');
            if (isDestructive) {
                confirmBtn.className = "px-4 py-2 bg-red-600 text-white text-base font-medium rounded-lg shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors cursor-pointer flex items-center justify-center";
            } else {
                confirmBtn.className = "px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-lg shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors cursor-pointer flex items-center justify-center";
            }

            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
            onConfirmAction = null;
        }

        async function executeConfirmAction() {
            if (onConfirmAction) {
                const btn = document.getElementById('confirm-action-btn');
                const spinner = document.getElementById('confirm-spinner');
                const text = document.getElementById('confirm-btn-text');
                const cancelBtn = document.getElementById('confirm-cancel-btn');

                // Show loading state
                btn.disabled = true;
                if (cancelBtn) cancelBtn.disabled = true;
                spinner.classList.remove('hidden');
                const originalText = text.textContent;
                text.textContent = 'Processing...';

                try {
                    await onConfirmAction();
                } finally {
                    // Reset state
                    btn.disabled = false;
                    if (cancelBtn) cancelBtn.disabled = false;
                    spinner.classList.add('hidden');
                    text.textContent = originalText;
                    closeConfirmModal();
                }
            } else {
                closeConfirmModal();
            }
        }

        // ================= TOAST NOTIFICATION =================
        function showToast(message, type = 'success') {
            // console.log(`Firebase Notification [${type}]:`, message);
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgClass = 'bg-green-600';
            let icon = '<i class="fa-solid fa-circle-check"></i>';
            
            if (type === 'error') {
                bgClass = 'bg-red-600';
                icon = '<i class="fa-solid fa-circle-exclamation"></i>';
            }

            toast.className = `${bgClass} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 transform transition-all duration-300 translate-y-10 opacity-0 min-w-[300px] pointer-events-auto`;
            toast.innerHTML = `${icon} <span class="font-medium text-sm">${message}</span>`;

            container.appendChild(toast);

            requestAnimationFrame(() => toast.classList.remove('translate-y-10', 'opacity-0'));
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-10'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // ================= NAVIGATION =================
        function showSection(sectionId) {
            const header = document.getElementById('main-header');
            ['admin-login-section', 'admin-dashboard-section'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
            
            document.getElementById(sectionId).classList.remove('hidden');

            if (sectionId === 'admin-login-section') {
                if(header) header.classList.remove('hidden');
                mainContainer.classList.remove('md:max-w-7xl', 'max-w-full');
                mainContainer.classList.add('max-w-md');
            } else {
                if(header) header.classList.add('hidden');
                mainContainer.classList.remove('max-w-md');
                mainContainer.classList.add('max-w-full', 'md:max-w-7xl');
                if (sectionId === 'admin-dashboard-section') {
                    document.getElementById('admin-year-input').value = academicYear;
                    fetchStudents(); // Load data when dashboard opens
                }
            }
        }

        async function logout() {
            await logActivity('LOGOUT', 'Instructor logged out');
            sessionStorage.removeItem('session_active');
            auth.signOut().then(() => {
                adminLoginForm.reset();
                adminErrorMsg.classList.add('hidden');
                // showSection handled by onAuthStateChanged
            }).catch(e => alert(e.message));
        }

        // ================= ACADEMIC YEAR LOGIC =================
        async function fetchSettings() {
            try {
                if (!auth || !auth.currentUser) return;
                const token = await auth.currentUser.getIdToken();
                const res = await fetch(`${API_BASE_URL}/api/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.academicYear) {
                        academicYear = data.academicYear;
                        const yearInput = document.getElementById('admin-year-input');
                        if (yearInput) yearInput.value = academicYear;
                    }
                    if (data.schoolName) {
                        schoolName = data.schoolName;
                        const schoolInput = document.getElementById('admin-school-input');
                        if (schoolInput) schoolInput.value = schoolName;
                    }
                }
            } catch (e) {
                // console.error("Error fetching settings:", e);
            }
        }

        async function updateSettings() {
            const yearInput = document.getElementById('admin-year-input').value.trim();
            const schoolInput = document.getElementById('admin-school-input').value.trim();
            
            if (yearInput || schoolInput) {
                try {
                    const token = await auth.currentUser.getIdToken();
                    const res = await fetch(`${API_BASE_URL}/api/settings`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ academicYear: yearInput, schoolName: schoolInput })
                    });
                    
                    if (!res.ok) throw new Error('Failed to save settings');
                    if (yearInput) academicYear = yearInput;
                    if (schoolInput) schoolName = schoolInput;
                    showToast('Settings updated successfully.');
                } catch (e) {
                    showToast('Error saving settings: ' + e.message, 'error');
                }
            }
        }

        function copyToClipboard(elementId, btn) {
            const el = document.getElementById(elementId);
            if (el && el.value) {
                navigator.clipboard.writeText(el.value).then(() => {
                    if (btn) {
                        const tooltip = btn.querySelector('.tooltip-text');
                        if (tooltip) {
                            tooltip.classList.remove('opacity-0');
                            setTimeout(() => tooltip.classList.add('opacity-0'), 1500);
                        }
                    }
                }).catch(err => {
                    // console.error('Failed to copy: ', err);
                    showToast('Failed to copy ID.', 'error');
                });
            }
        }

        // Ensure sidebar visibility on resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                const sidebar = document.getElementById('sidebar-content');
                if (sidebar) sidebar.classList.remove('hidden');
            }
        });

        // ================= HELPER FUNCTIONS =================
        function calculateAvg(...values) {
            const validValues = values
                .map(v => parseFloat(v))
                .filter(v => !isNaN(v));
            if (validValues.length === 0) return null;
            const sum = validValues.reduce((a, b) => a + b, 0);
            return sum / validValues.length;
        }

        function calculateStats(student) {
            let totalYearlyAvgSum = 0;
            
            student.subjects.forEach(sub => {
                const avg1 = calculateAvg(sub.p1, sub.p2, sub.p3, sub.exam1);
                const avg2 = calculateAvg(sub.p4, sub.p5, sub.p6, sub.exam2);
                
                let yearly = 0;
                if (avg1 !== null && avg2 !== null) {
                    yearly = (avg1 + avg2) / 2;
                } else if (avg1 !== null) {
                    yearly = avg1;
                } else if (avg2 !== null) {
                    yearly = avg2;
                }
                
                totalYearlyAvgSum += yearly;
            });
            
            const overallPercentage = student.subjects.length > 0 ? (totalYearlyAvgSum / student.subjects.length) : 0;
            return { percentage: overallPercentage };
        }

        // ================= ADMIN LOGIC =================
        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const p = document.getElementById('admin-password').value;
            if (!auth) return; // Wait for init

            const btn = document.getElementById('admin-login-btn');
            const spinner = document.getElementById('login-spinner');
            
            btn.disabled = true;
            spinner.classList.remove('hidden');

            auth.signInWithEmailAndPassword(email, p)
                .then((userCredential) => {
                    // Signed in 
                    adminErrorMsg.classList.add('hidden');
                    // showSection handled by onAuthStateChanged
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                })
                .catch((error) => {
                    btn.disabled = false;
                    spinner.classList.add('hidden');
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    // console.error('Firebase Notification [Login Error]:', errorMessage);
                    document.getElementById('login-error-text').textContent = errorMessage;
                    adminErrorMsg.classList.remove('hidden');
                });
        });

        function updateAdminDashboard() {
            let totalPercentageSum = 0;
            let bestStudent = { name: "None", percentage: -1 };
            let passCount = 0;
            let failCount = 0;

            students.forEach(student => {
                const stats = calculateStats(student);
                totalPercentageSum += stats.percentage;
                
                if (stats.percentage >= 70) passCount++;
                else failCount++;
                
                if (stats.percentage > bestStudent.percentage) {
                    bestStudent = { name: student.name, percentage: stats.percentage };
                }
            });

            document.getElementById('admin-total-students').textContent = students.length;
            const avg = students.length > 0 ? (totalPercentageSum / students.length).toFixed(1) : 0;
            document.getElementById('admin-class-avg').textContent = avg + "%";
            document.getElementById('admin-top-student').textContent = bestStudent.name;
            
            // Update Pass/Fail
            const passEl = document.getElementById('admin-pass-count');
            const failEl = document.getElementById('admin-fail-count');
            if(passEl) passEl.textContent = passCount;
            if(failEl) failEl.textContent = failCount;

            updateClassFilterDropdown();
            filterStudentList();
            renderTopPerformersSection();
        }

        function updateClassFilterDropdown() {
            const filter = document.getElementById('class-filter');
            const currentVal = filter.value;
            
            // Extract unique classes
            const classes = [...new Set(students.map(s => s.class).filter(c => c))].sort();
            
            filter.innerHTML = '<option value="">All Classes</option>';
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                filter.appendChild(opt);
            });
            
            // Restore selection if possible
            if (classes.includes(currentVal)) {
                filter.value = currentVal;
            }
        }

        let showArchived = false;

        function toggleArchivedView() {
            showArchived = !showArchived;
            const btn = document.getElementById('toggle-archived-btn');
            if (showArchived) {
                btn.innerHTML = '<i class="fa-solid fa-users text-indigo-600"></i> Show Active Students';
            } else {
                btn.innerHTML = '<i class="fa-solid fa-box-archive text-gray-500"></i> Show Archived';
            }
            filterStudentList();
        }

        function filterStudentList(resetPage = true) {
            const filterVal = document.getElementById('class-filter').value;
            const searchVal = document.getElementById('student-search').value.toLowerCase().trim();

            currentFilteredStudents = students.filter(s => {
                const matchesClass = filterVal ? s.class === filterVal : true;
                const matchesSearch = s.name.toLowerCase().includes(searchVal) || s.id.toLowerCase().includes(searchVal);
                const matchesArchive = showArchived ? s.isArchived : !s.isArchived;
                return matchesClass && matchesSearch && matchesArchive;
            });

            if (resetPage) currentPage = 1;
            renderStudentTable();
        }

        function renderStudentTable() {
            const tbody = document.getElementById('admin-student-list');
            tbody.innerHTML = '';

            if (currentFilteredStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No students found.</td></tr>';
                updatePaginationControls();
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageStudents = currentFilteredStudents.slice(start, end);
            
            // Update header checkbox state based on current page selection
            const allSelected = pageStudents.length > 0 && pageStudents.every(s => selectedStudentIds.has(s.id));
            document.getElementById('select-all-checkbox').checked = allSelected;

            pageStudents.forEach(student => {
                const stats = calculateStats(student);
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50";
                const formattedDate = student.updatedAt ? new Date(student.updatedAt).toLocaleString() : 'N/A';
                const isSelected = selectedStudentIds.has(student.id);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="student-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" 
                            value="${student.id}" 
                            ${isSelected ? 'checked' : ''} 
                            onchange="toggleStudentSelection('${student.id}')">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">${student.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.class}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 py-1 rounded text-xs font-bold ${stats.percentage >= 70 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${stats.percentage.toFixed(1)}%
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${!showArchived ? 
                        `<button onclick="promoteStudent('${student.id}')" class="text-green-600 hover:text-green-900 mr-3 cursor-pointer" title="Promote"><i class="fa-solid fa-arrow-trend-up"></i></button>
                         <button onclick="printStudentReport('${student.id}')" class="text-gray-600 hover:text-gray-900 mr-3 cursor-pointer" title="Print Report"><i class="fa-solid fa-print"></i></button>
                         <button onclick="openEditModal('${student.id}')" class="text-indigo-600 hover:text-indigo-900 cursor-pointer">Edit</button>`
                        : '' }
                    </td>
                `;
                tbody.appendChild(row);
            });
            updatePaginationControls();
        }

        function changePage(delta) {
            const totalPages = Math.ceil(currentFilteredStudents.length / itemsPerPage) || 1;
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderStudentTable();
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(currentFilteredStudents.length / itemsPerPage) || 1;
            document.getElementById('pagination-info').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;
        }

        // ================= BULK ACTIONS LOGIC =================
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const isChecked = selectAllCheckbox.checked;
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageStudents = currentFilteredStudents.slice(start, end);
            
            pageStudents.forEach(student => {
                if (isChecked) {
                    selectedStudentIds.add(student.id);
                } else {
                    selectedStudentIds.delete(student.id);
                }
            });
            
            renderStudentTable();
        }

        function toggleStudentSelection(id) {
            if (selectedStudentIds.has(id)) {
                selectedStudentIds.delete(id);
            } else {
                selectedStudentIds.add(id);
            }
            
            // Update header checkbox
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageStudents = currentFilteredStudents.slice(start, end);
            const allSelected = pageStudents.length > 0 && pageStudents.every(s => selectedStudentIds.has(s.id));
            document.getElementById('select-all-checkbox').checked = allSelected;
        }

        async function bulkDelete() {
            if (selectedStudentIds.size === 0) {
                showToast("No students selected.", "error");
                return;
            }
            
            openConfirmModal(
                "Confirm Bulk Delete",
                `Are you sure you want to delete ${selectedStudentIds.size} selected students? This action cannot be undone.`,
                async () => {
                    const promises = [];
                    for (const id of selectedStudentIds) {
                        promises.push(deleteStudentApi(id, true));
                    }
                    
                    try {
                        await Promise.all(promises);
                        selectedStudentIds.clear();
                        await fetchStudents();
                        showToast("Bulk delete completed.");
                    } catch (e) {
                        showToast("Some deletions failed.", "error");
                        await fetchStudents();
                    }
                },
                true // isDestructive
            );
        }

        // ================= EDIT/ADD STUDENT LOGIC =================
        function generateNewId() {
            // Get the year from the edit input if available, otherwise global setting
            const yearInput = document.getElementById('edit-year').value.trim();
            const baseYearStr = yearInput || academicYear || new Date().getFullYear().toString();
            
            // Extract the 4-digit year (e.g., "2023-2024" -> "2023")
            const yearMatch = baseYearStr.match(/^(\d{4})/);
            const prefix = yearMatch ? yearMatch[1] : new Date().getFullYear().toString();

            // Find the highest sequence number for this prefix among existing students
            let maxSeq = 0;
            students.forEach(s => {
                const sid = String(s.id);
                if (sid.startsWith(prefix)) {
                    // Extract the part after the year
                    const suffix = sid.substring(prefix.length);
                    // Check if it's a valid number (expecting 6 digits)
                    if (/^\d+$/.test(suffix)) {
                        const seq = parseInt(suffix, 10);
                        if (seq > maxSeq) maxSeq = seq;
                    }
                }
            });

            // Increment and pad to 6 digits
            const nextSeq = maxSeq + 1;
            const nextId = `${prefix}${nextSeq.toString().padStart(6, '0')}`;
            
            document.getElementById('edit-id').value = nextId;
        }

        function openEditModal(studentId = null) {
            const modal = document.getElementById('admin-edit-section');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('edit-student-form');
            const container = document.getElementById('subjects-container');
            const modeInput = document.getElementById('edit-mode');
            const lastUpdatedEl = document.getElementById('modal-last-updated');

            container.innerHTML = ''; 
            modal.classList.remove('hidden');

            if (studentId) {
                currentEditId = studentId;
                modeInput.value = 'edit';
                title.textContent = 'Edit Student Results';
                const student = students.find(s => s.id === studentId);

                document.getElementById('edit-name').value = student.name;
                document.getElementById('edit-id').value = student.id;
                document.getElementById('edit-class').value = student.class;
                document.getElementById('edit-roll').value = student.roll;
                document.getElementById('edit-year').value = student.year;
                document.getElementById('edit-principal-comment').value = student.principalComment;

                if (student.updatedAt) {
                    lastUpdatedEl.textContent = `Last updated: ${new Date(student.updatedAt).toLocaleString()}`;
                } else {
                    lastUpdatedEl.textContent = '';
                }
                document.getElementById('edit-id').readOnly = true; 
                document.getElementById('edit-id').classList.add('bg-gray-100');

                student.subjects.forEach(sub => {
                    addSubjectRow(sub.name, sub);
                });
            } else {
                currentEditId = null;
                modeInput.value = 'add';
                title.textContent = 'Add New Student';
                form.reset();
                document.getElementById('edit-id').readOnly = true;
                document.getElementById('edit-id').classList.add('bg-gray-100');
                document.getElementById('edit-year').value = academicYear; // Default to global setting
                lastUpdatedEl.textContent = 'This is a new student record.';
                document.getElementById('edit-principal-comment').value = '';
                
                addSubjectRow('Mathematics');
                addSubjectRow('Science');
                addSubjectRow('English');
                addSubjectRow('History');
                
                generateNewId();
            }
        }

        function closeEditModal() {
            document.getElementById('admin-edit-section').classList.add('hidden');
        }

        function addSubjectRow(name = '', data = null) {
            const container = document.getElementById('subjects-container');
            const tr = document.createElement('tr');
            
            // Def values
            const p1 = data ? (data.p1 === null ? '' : data.p1) : '';
            const p2 = data ? (data.p2 === null ? '' : data.p2) : '';
            const p3 = data ? (data.p3 === null ? '' : data.p3) : '';
            const exam1 = data ? (data.exam1 === null ? '' : data.exam1) : '';
            const sem1 = data ? (data.sem1 === null ? '' : data.sem1) : '';
            const p4 = data ? (data.p4 === null ? '' : data.p4) : '';
            const p5 = data ? (data.p5 === null ? '' : data.p5) : '';
            const p6 = data ? (data.p6 === null ? '' : data.p6) : '';
            const exam2 = data ? (data.exam2 === null ? '' : data.exam2) : '';
            const sem2 = data ? (data.sem2 === null ? '' : data.sem2) : '';
            const comment = data ? (data.comment || '') : '';

            tr.innerHTML = `
                <td class="px-3 py-2">
                    <input type="text" class="subject-name block w-full rounded border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1 px-2" placeholder="Subject Name" value="${name}" required>
                </td>
                <td class="px-1 py-2">
                    <input type="number" class="p1 block w-full text-center rounded border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1" placeholder="-" value="${p1}">
                </td>
                <td class="px-1 py-2">
                    <input type="number" class="p2 block w-full text-center rounded border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1" placeholder="-" value="${p2}">
                </td>
                <td class="px-1 py-2">
                    <input type="number" class="p3 block w-full text-center rounded border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1" placeholder="-" value="${p3}">
                </td>
                <td class="px-1 py-2 bg-indigo-50">
                    <input type="number" class="exam1 block w-full text-center rounded border-indigo-200 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1 bg-white" placeholder="Ex" value="${exam1}">
                </td>
                <td class="px-1 py-2 bg-gray-50">
                    <input type="number" class="sem1 block w-full text-center rounded border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1 bg-gray-100 text-gray-500 cursor-not-allowed" placeholder="Avg" value="${sem1}" readonly tabindex="-1">
                </td>
                <td class="px-1 py-2 border-l border-gray-200">
                    <input type="number" class="p4 block w-full text-center rounded border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1" placeholder="-" value="${p4}">
                </td>
                <td class="px-1 py-2">
                    <input type="number" class="p5 block w-full text-center rounded border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1" placeholder="-" value="${p5}">
                </td>
                <td class="px-1 py-2">
                    <input type="number" class="p6 block w-full text-center rounded border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1" placeholder="-" value="${p6}">
                </td>
                <td class="px-1 py-2 bg-indigo-50">
                    <input type="number" class="exam2 block w-full text-center rounded border-indigo-200 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1 bg-white" placeholder="Ex" value="${exam2}">
                </td>
                <td class="px-1 py-2 bg-gray-50">
                    <input type="number" class="sem2 block w-full text-center rounded border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1 bg-gray-100 text-gray-500 cursor-not-allowed" placeholder="Avg" value="${sem2}" readonly tabindex="-1">
                </td>
                <td class="px-3 py-2">
                    <input type="text" class="subject-comment block w-full rounded border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 text-sm py-1 px-2" placeholder="Optional" value="${comment}">
                </td>
                <td class="px-2 py-2 text-center">
                    <button type="button" onclick="this.closest('tr').remove()" class="text-gray-400 hover:text-red-500 transition-colors">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </td>
            `;
            container.appendChild(tr);
        }

        // Auto-calculate averages when inputs change
        document.getElementById('subjects-container').addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
                const row = e.target.closest('tr');
                const cls = e.target.classList;
                
                const getVal = (c) => {
                    const val = row.querySelector('.' + c).value;
                    return val === '' ? null : parseFloat(val);
                };

                // Semester 1 Calculation
                if (cls.contains('p1') || cls.contains('p2') || cls.contains('p3') || cls.contains('exam1')) {
                    const avg = calculateAvg(getVal('p1'), getVal('p2'), getVal('p3'), getVal('exam1'));
                    row.querySelector('.sem1').value = avg !== null ? avg.toFixed(1) : '';
                }

                // Semester 2 Calculation
                if (cls.contains('p4') || cls.contains('p5') || cls.contains('p6') || cls.contains('exam2')) {
                    const avg = calculateAvg(getVal('p4'), getVal('p5'), getVal('p6'), getVal('exam2'));
                    row.querySelector('.sem2').value = avg !== null ? avg.toFixed(1) : '';
                }
            }
        });

        // Auto-update ID when year changes in Add mode
        document.getElementById('edit-year').addEventListener('input', () => {
            const mode = document.getElementById('edit-mode').value;
            if (mode === 'add') {
                generateNewId();
            }
        });

        editStudentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const mode = document.getElementById('edit-mode').value;
            const newId = document.getElementById('edit-id').value.trim();
            
            const subjectRows = document.querySelectorAll('#subjects-container > tr');
            const newSubjects = [];
            
            const getVal = (row, cls) => {
                const val = row.querySelector('.' + cls).value;
                return val === '' ? null : parseFloat(val);
            };

            subjectRows.forEach(row => {
                const name = row.querySelector('.subject-name').value;
                const p1 = getVal(row, 'p1');
                const p2 = getVal(row, 'p2');
                const p3 = getVal(row, 'p3');
                const exam1 = getVal(row, 'exam1');
                const sem1 = getVal(row, 'sem1');
                const p4 = getVal(row, 'p4');
                const p5 = getVal(row, 'p5');
                const p6 = getVal(row, 'p6');
                const exam2 = getVal(row, 'exam2');
                const sem2 = getVal(row, 'sem2');
                const comment = row.querySelector('.subject-comment').value.trim();
                newSubjects.push({ name, p1, p2, p3, exam1, sem1, p4, p5, p6, exam2, sem2, comment });
            });

            const studentData = {
                id: newId,
                name: document.getElementById('edit-name').value.trim(),
                class: document.getElementById('edit-class').value.trim(),
                roll: document.getElementById('edit-roll').value.trim(),
                year: document.getElementById('edit-year').value.trim(),
                principalComment: document.getElementById('edit-principal-comment').value.trim(),
                isArchived: false, // Default to false when editing/adding via modal
                subjects: newSubjects
            };

            saveStudentApi(studentData, mode === 'edit');
        });

        async function promoteStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;

            // Heuristic to guess next academic year
            let nextYear = "";
            const currentYear = student.year || academicYear;
            const yearParts = currentYear.split('-');
            if (yearParts.length === 2) {
                const y1 = parseInt(yearParts[0]);
                const y2 = parseInt(yearParts[1]);
                if (!isNaN(y1) && !isNaN(y2)) {
                    nextYear = `${y1 + 1}-${y2 + 1}`;
                }
            }

            // Heuristic to guess next class (increment integer part)
            let nextClass = student.class;
            const classMatch = student.class.match(/(\d+)/);
            if (classMatch) {
                const num = parseInt(classMatch[0]);
                nextClass = student.class.replace(num, num + 1);
            }

            const newClass = prompt(`Promote ${student.name}?\n\nCurrent Class: ${student.class}\nCurrent Year: ${currentYear}\n\nEnter New Class:`, nextClass);
            if (newClass === null) return;

            const newYear = prompt("Enter New Academic Year:", nextYear || "2024-2025");
            if (newYear === null) return;

            const clearGrades = confirm("Do you want to clear existing grades for the new class?\n(OK = Clear Grades, Cancel = Keep Grades)");

            const updatedStudent = {
                ...student,
                class: newClass,
                year: newYear,
                subjects: clearGrades ? [] : student.subjects
            };

            await saveStudentApi(updatedStudent, true);
        }

        // ================= EXPORT & PRINT LOGIC =================
        function exportToCSV() {
            // Define headers
            const headers = ["ID", "Name", "Class", "Roll", "Academic Year", "Percentage", "Principal Comment"];
            
            const rows = [headers];
            
            students.forEach(s => {
                const stats = calculateStats(s);
                // Escape quotes
                const escape = (val) => `"${(val || '').toString().replace(/"/g, '""')}"`;
                
                rows.push([
                    escape(s.id),
                    escape(s.name),
                    escape(s.class),
                    escape(s.roll),
                    escape(s.year),
                    escape(stats.percentage.toFixed(2) + '%'),
                    escape(s.principalComment)
                ]);
            });
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + rows.map(e => e.join(",")).join("\n");
                
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "students_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printStudentReport(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;

            const stats = calculateStats(student);
            
            // Helper for grades
            const getGrade = (score) => {
                if (score >= 90) return 'A';
                if (score >= 80) return 'B';
                if (score >= 70) return 'C';
                return 'F';
            };
            
            const safeVal = (v) => (v === null || v === undefined || v === '') ? '-' : v;

            let rowsHtml = '';
            student.subjects.forEach(sub => {
                const avg1 = calculateAvg(sub.p1, sub.p2, sub.p3, sub.exam1);
                const avg2 = calculateAvg(sub.p4, sub.p5, sub.p6, sub.exam2);
                let yearly = null;
                if (avg1 !== null && avg2 !== null) yearly = (avg1 + avg2) / 2;
                else if (avg1 !== null) yearly = avg1;
                else if (avg2 !== null) yearly = avg2;
                
                rowsHtml += `
                    <tr>
                        <td class="border px-4 py-2">${sub.name}</td>
                        <td class="border px-2 py-2 text-center">${safeVal(sub.p1)}</td>
                        <td class="border px-2 py-2 text-center">${safeVal(sub.p2)}</td>
                        <td class="border px-2 py-2 text-center">${safeVal(sub.p3)}</td>
                        <td class="border px-2 py-2 text-center">${safeVal(sub.exam1)}</td>
                        <td class="border px-2 py-2 text-center font-bold bg-gray-50">${avg1 !== null ? avg1.toFixed(1) : '-'}</td>
                        <td class="border px-2 py-2 text-center">${safeVal(sub.p4)}</td>
                        <td class="border px-2 py-2 text-center">${safeVal(sub.p5)}</td>
                        <td class="border px-2 py-2 text-center">${safeVal(sub.p6)}</td>
                        <td class="border px-2 py-2 text-center">${safeVal(sub.exam2)}</td>
                        <td class="border px-2 py-2 text-center font-bold bg-gray-50">${avg2 !== null ? avg2.toFixed(1) : '-'}</td>
                        <td class="border px-2 py-2 text-center font-bold">${yearly !== null ? yearly.toFixed(1) : '-'}</td>
                        <td class="border px-2 py-2 text-center">${yearly !== null ? getGrade(yearly) : '-'}</td>
                        <td class="border px-4 py-2 text-sm italic">${sub.comment || ''}</td>
                    </tr>
                `;
            });

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Report Card - ${student.name}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                </head>
                <body class="p-8 bg-white">
                    <div class="max-w-4xl mx-auto border border-gray-300 p-8 rounded-xl">
                        <div class="text-center border-b-2 border-indigo-600 pb-6 mb-6">
                             <h1 class="text-3xl font-bold text-gray-900 uppercase">Emmanuel Suah Academy</h1>
                             <p class="text-gray-600">New Israel Community, Brewerville, Montserrado County, Liberia</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                            <div><strong>Name:</strong> ${student.name}</div>
                            <div><strong>ID:</strong> ${student.id}</div>
                            <div><strong>Class:</strong> ${student.class}</div>
                            <div><strong>Academic Year:</strong> ${student.year}</div>
                        </div>
                        <table class="w-full border-collapse border border-gray-300 text-sm mb-6">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border px-4 py-2 text-left">Subject</th>
                                    <th class="border px-2 py-2">1st</th>
                                    <th class="border px-2 py-2">2nd</th>
                                    <th class="border px-2 py-2">3rd</th>
                                    <th class="border px-2 py-2">1st Sem</th>
                                    <th class="border px-2 py-2">Avg1</th>
                                    <th class="border px-2 py-2">4th</th>
                                    <th class="border px-2 py-2">5th</th>
                                    <th class="border px-2 py-2">6th</th>
                                    <th class="border px-2 py-2">2nd Sem</th>
                                    <th class="border px-2 py-2">Avg2</th>
                                    <th class="border px-2 py-2">Yearly</th>
                                    <th class="border px-2 py-2">Grade</th>
                                    <th class="border px-4 py-2 text-left">Remarks</th>
                                </tr>
                            </thead>
                            <tbody>${rowsHtml}</tbody>
                            <tfoot>
                                <tr class="bg-gray-50 font-bold">
                                    <td colspan="9" class="border px-4 py-2 text-right">Overall Percentage:</td>
                                    <td class="border px-2 py-2 text-center">${stats.percentage.toFixed(1)}%</td>
                                    <td class="border px-2 py-2 text-center">${getGrade(stats.percentage)}</td>
                                    <td class="border"></td>
                                </tr>
                            </tfoot>
                        </table>
                        <div class="mt-8 pt-4 border-t border-gray-200">
                            <p class="text-sm"><strong>Principal's Remarks:</strong> ${student.principalComment || 'No remarks.'}</p>
                        </div>
                    </div>
                    <script>
                        setTimeout(() => { window.print(); window.close(); }, 500);
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // ================= TOP PERFORMERS LOGIC =================
        function renderTopPerformersSection() {
            const filter = document.getElementById('top-class-filter');
            
            // Get unique classes
            const classes = [...new Set(students.map(s => s.class))].sort();
            
            // Save current selection if exists and still valid
            const currentSelection = filter.value;
            
            filter.innerHTML = '';
            if (classes.length === 0) {
                filter.innerHTML = '<option value="">No Classes Found</option>';
                renderTopList(); 
                return;
            }

            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                filter.appendChild(opt);
            });

            // Restore selection or default to first
            if (currentSelection && classes.includes(currentSelection)) {
                filter.value = currentSelection;
            } else {
                filter.value = classes[0];
            }

            renderTopList();
        }

        function renderTopList() {
            const selectedClass = document.getElementById('top-class-filter').value;
            const listContainer = document.getElementById('top-performers-list');
            listContainer.innerHTML = '';

            if (!selectedClass) {
                listContainer.innerHTML = '<p class="text-gray-500 text-sm col-span-2 md:col-span-5 text-center py-4">No student data available.</p>';
                return;
            }

            // Filter and Sort
            const classStudents = students
                .filter(s => s.class === selectedClass)
                .map(s => ({ ...s, stats: calculateStats(s) }))
                .sort((a, b) => b.stats.percentage - a.stats.percentage)
                .slice(0, 5);

            if (classStudents.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-sm col-span-2 md:col-span-5 text-center py-4">No students found in this class.</p>';
                return;
            }

            classStudents.forEach((s, index) => {
                const colors = [
                    'bg-yellow-50 text-yellow-800 border-yellow-200 ring-1 ring-yellow-200', 
                    'bg-gray-50 text-gray-800 border-gray-200 ring-1 ring-gray-200', 
                    'bg-orange-50 text-orange-800 border-orange-200 ring-1 ring-orange-200'
                ];
                const cardStyle = colors[index] || 'bg-white text-indigo-700 border-gray-100 ring-1 ring-gray-100';
                const medal = index === 0 ? '<i class="fa-solid fa-crown text-yellow-500 text-2xl drop-shadow-sm"></i>' : `<span class="text-xl font-bold text-gray-400">#${index + 1}</span>`;
                const nameColor = index === 0 ? 'text-gray-900' : 'text-gray-700';
                
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl border ${cardStyle} flex flex-col items-center justify-center text-center shadow-sm relative overflow-hidden transition-transform hover:-translate-y-1 duration-300`;
                card.innerHTML = `
                    <div class="mb-2">${medal}</div>
                    <div class="font-bold text-sm truncate w-full ${nameColor}" title="${s.name}">${s.name}</div>
                    <div class="text-xs opacity-60 mb-2 font-mono">ID: ${s.id}</div>
            <div class="mt-1"><span class="text-xs opacity-70 font-medium text-gray-500">Average</span><div class="text-xl font-extrabold">${s.stats.percentage.toFixed(1)}%</div></div>
                `;
                listContainer.appendChild(card);
            });
        }
        
        // Initial setup
        // showSection('admin-login-section'); // Handled by onAuthStateChanged
    </script>
</body>
</html>