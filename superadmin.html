<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <header class="w-full max-w-7xl flex justify-between items-center mb-6 px-4 md:px-0">
        <div class="flex items-center gap-3 text-gray-800">
            <i class="fa-solid fa-user-secret text-3xl"></i>
            <h1 class="text-xl md:text-2xl font-bold">Super<span class="text-teal-600">Admin</span> Monitor</h1>
        </div>
        <button onclick="logout()" id="logout-btn" class="hidden bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700 transition">
            Logout
        </button>
    </header>

    <!-- Login Section -->
    <div id="login-section" class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden fade-in">
        <div class="p-8">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-900 text-white mb-4">
                    <i class="fa-solid fa-user-secret text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Staff Login</h2>
                <p class="text-gray-500 mt-2">Enter your credentials to access the dashboard.</p>
            </div>

            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                    <input type="email" id="email" class="block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-teal-500 focus:border-teal-500 py-3 px-4 text-gray-900" placeholder="admin@example.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="password" class="block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-teal-500 focus:border-teal-500 py-3 px-4 text-gray-900 pr-10" placeholder="••••••••" required>
                        <button type="button" onclick="togglePasswordVisibility()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 cursor-pointer">
                            <i class="fa-solid fa-eye" id="password-toggle-icon"></i>
                        </button>
                    </div>
                </div>
                
                <div id="error-msg" class="hidden bg-red-50 text-red-600 p-3 rounded-lg text-sm flex items-center gap-2">
                    <i class="fa-solid fa-circle-exclamation"></i>
                    <span id="error-text">Invalid Credentials.</span>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-900">Remember me</label>
                    </div>
                    <button type="button" onclick="openForgotModal()" class="text-sm text-teal-600 hover:text-teal-800 font-medium cursor-pointer">Forgot Password?</button>
                </div>

                <button type="submit" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gray-900 hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors cursor-pointer">
                    Login to Dashboard
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <a href="index.html" class="text-sm text-gray-500 hover:text-gray-900 font-medium">
                    &larr; Back to Home
                </a>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="hidden w-full max-w-7xl bg-white rounded-xl shadow-lg overflow-hidden fade-in flex flex-col h-[80vh]">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <h2 class="text-lg font-bold text-gray-800 mb-4 md:mb-0">Instructor Activity Logs</h2>
            <div class="flex flex-wrap gap-2 items-center w-full md:w-auto justify-start md:justify-end">
                <select id="user-type-filter" onchange="fetchLogs()" class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-teal-500 focus:border-teal-500 w-full sm:w-auto">
                    <option value="">All Users</option>
                    <option value="INSTRUCTOR">Instructors</option>
                    <option value="STUDENT">Students</option>
                </select>
                <select id="action-filter" onchange="fetchLogs()" class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-teal-500 focus:border-teal-500 w-full sm:w-auto">
                    <option value="">All Actions</option>
                    <option value="LOGIN">Instructor Login</option>
                    <option value="LOGOUT">Instructor Logout</option>
                    <option value="STUDENT_LOGIN">Student Login</option>
                    <option value="ADD_STUDENT">Add Student</option>
                    <option value="DELETE_STUDENT">Delete Student</option>
                    <option value="BAN_INSTRUCTOR">Ban Instructor</option>
                    <option value="UNBAN_INSTRUCTOR">Unban Instructor</option>
                    <option value="GENERATE_RESET_LINK">Generate Reset Link</option>
                    <option value="CLEANUP_LOGS">Cleanup Logs</option>
                    <option value="SYSTEM_BACKUP">System Backup</option>
                </select>
                <input type="text" id="search-input" placeholder="Search logs..." class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-teal-500 focus:border-teal-500 w-full sm:w-32 md:w-48">
                <input type="date" id="start-date" class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-teal-500 focus:border-teal-500 w-full sm:w-auto">
                <span class="text-gray-400 text-sm">to</span>
                <input type="date" id="end-date" class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-teal-500 focus:border-teal-500 w-full sm:w-auto">
                <button onclick="fetchLogs()" class="bg-teal-600 text-white px-3 py-1 rounded text-sm hover:bg-teal-700 transition mr-2 cursor-pointer">Filter</button>

                <button onclick="viewInstructors()" class="text-teal-600 hover:text-teal-800 text-sm font-medium cursor-pointer border-l pl-2 border-gray-300" title="View Instructors">
                    <i class="fa-solid fa-users"></i> Instructors
                </button>
                <!-- Database Controls -->
                <button onclick="backupDatabase()" class="text-blue-600 hover:text-blue-800 text-sm font-medium cursor-pointer border-l pl-2 border-gray-300" title="Download Backup">
                    <i class="fa-solid fa-download"></i> Backup
                </button>
                <button onclick="triggerRestore()" class="text-orange-600 hover:text-orange-800 text-sm font-medium cursor-pointer" title="Restore Database">
                    <i class="fa-solid fa-upload"></i> Restore
                </button>
                <input type="file" id="restore-file-input" class="hidden" accept=".json" onchange="restoreDatabase(this)">

                <button onclick="deleteOldLogs()" class="text-red-600 hover:text-red-800 text-sm font-medium cursor-pointer border-l pl-2 border-gray-300" title="Delete old logs">
                    <i class="fa-solid fa-trash-can"></i> Cleanup
                </button>
                <button onclick="exportLogsToCSV()" class="text-green-600 hover:text-green-800 text-sm font-medium cursor-pointer">
                    <i class="fa-solid fa-file-csv"></i> Export CSV
                </button>
                <button onclick="fetchLogs()" class="text-teal-600 hover:text-teal-800 text-sm font-medium cursor-pointer">
                    <i class="fa-solid fa-rotate"></i> Refresh Logs
                </button>
            </div>
        </div>
        
        <div class="flex-1 overflow-auto p-0">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                    </tr>
                </thead>
                <tbody id="logs-body" class="bg-white divide-y divide-gray-200">
                    <!-- Logs go here -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
            <span class="text-sm text-gray-600" id="page-info">Page 1 of 1</span>
            <div class="flex gap-2">
                <button onclick="changePage(-1)" id="prev-btn" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                <button onclick="changePage(1)" id="next-btn" class="px-3 py-1 bg-white border border-gray-300 rounded text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="hidden fixed inset-0 bg-gray-600/50 overflow-y-auto h-full w-full z-50 fade-in flex items-center justify-center">
        <div class="relative p-6 border w-96 shadow-lg rounded-xl bg-white">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 mb-4">
                    <i class="fa-solid fa-key text-teal-600"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Reset Password</h3>
                <p class="text-sm text-gray-500 mt-2 mb-4">Enter your email to receive a reset link.</p>
                <input type="email" id="reset-email" class="block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-teal-500 focus:border-teal-500 py-2 px-3 text-gray-900 mb-2" placeholder="admin@example.com">
                <p id="reset-msg" class="text-xs mb-4 hidden"></p>
                <div class="flex gap-2">
                    <button onclick="closeForgotModal()" class="w-1/2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition cursor-pointer">Cancel</button>
                    <button onclick="sendResetEmail()" class="w-1/2 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition cursor-pointer">Send Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Details Modal -->
    <div id="log-modal" class="hidden fixed inset-0 bg-gray-600/50 overflow-y-auto h-full w-full z-50 fade-in flex items-center justify-center">
        <div class="relative p-6 border w-11/12 md:w-1/2 shadow-lg rounded-xl bg-white">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-900">Log Details</h3>
                <button onclick="closeLogModal()" class="text-gray-400 hover:text-gray-700 cursor-pointer">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="space-y-3 text-sm">
                <div><span class="font-bold text-gray-700">Timestamp:</span> <span id="modal-timestamp" class="text-gray-600"></span></div>
                <div><span class="font-bold text-gray-700">Instructor:</span> <span id="modal-instructor" class="text-gray-600"></span></div>
                <div><span class="font-bold text-gray-700">Instructor ID:</span> <span id="modal-instructor-id" class="text-gray-600 font-mono text-xs bg-gray-100 px-1 rounded"></span></div>
                <div><span class="font-bold text-gray-700">Action:</span> <span id="modal-action" class="font-bold"></span></div>
                <div>
                    <span class="font-bold text-gray-700 block mb-1">Details:</span>
                    <div id="modal-details" class="bg-gray-50 p-3 rounded border border-gray-200 text-gray-800 whitespace-pre-wrap"></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeLogModal()" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700 transition cursor-pointer">Close</button>
            </div>
        </div>
    </div>

    <!-- Instructors List Modal -->
    <div id="instructors-modal" class="hidden fixed inset-0 bg-gray-600/50 overflow-y-auto h-full w-full z-50 fade-in flex items-center justify-center">
        <div class="relative p-6 border w-11/12 md:w-2/3 shadow-lg rounded-xl bg-white max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-900">Instructor List</h3>
                <button onclick="closeInstructorsModal()" class="text-gray-400 hover:text-gray-700 cursor-pointer">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            <div class="flex-1 overflow-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Login</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="instructors-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeInstructorsModal()" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700 transition cursor-pointer">Close</button>
            </div>
        </div>
    </div>

    <!-- Restore Confirmation Modal -->
    <div id="restore-confirm-modal" class="hidden fixed inset-0 bg-gray-600/50 overflow-y-auto h-full w-full z-50 fade-in flex items-center justify-center">
        <div class="relative p-6 border w-96 shadow-lg rounded-xl bg-white">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900">Confirm Database Restore</h3>
                <p class="text-sm text-gray-500 mt-2 mb-4">WARNING: This action will overwrite all existing student data with the backup file. This cannot be undone.</p>
                <div class="flex gap-2">
                    <button onclick="closeRestoreModal()" class="w-1/2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition cursor-pointer">Cancel</button>
                    <button onclick="executeRestore()" class="w-1/2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition cursor-pointer">Proceed</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Loading Spinner -->
    <div id="global-spinner" class="hidden fixed inset-0 bg-gray-900/50 z-[60] flex items-center justify-center fade-in">
        <div class="bg-white p-5 rounded-xl shadow-2xl flex flex-col items-center">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-teal-600 mb-3"></i>
            <p class="text-gray-700 font-medium" id="global-spinner-text">Processing...</p>
        </div>
    </div>

    <script>
        const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:3000'
            : 'https://progressreport-7jlm.onrender.com';

        let auth;
        let currentLogs = [];
        let currentPage = 1;
        const itemsPerPage = 15;

        // Initialize Firebase
        async function init() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/config/firebase`);
                const config = await response.json();
                firebase.initializeApp(config);
                auth = firebase.auth();

                auth.onAuthStateChanged(async user => {
                    if (user) {
                        try {
                            // Check against server to support Env Var configuration
                            const token = await user.getIdToken();
                            const res = await fetch(`${API_BASE_URL}/api/auth/is-superadmin`, {
                                headers: { 'Authorization': `Bearer ${token}` }
                            });

                            // Ensure response is JSON before parsing to avoid "Unexpected token" errors
                            const contentType = res.headers.get("content-type");
                            if (!contentType || !contentType.includes("application/json")) {
                                throw new Error("Server returned non-JSON response (likely HTML error page).");
                            }

                            const data = await res.json();

                            if (data.isSuperAdmin) {
                                document.getElementById('login-section').classList.add('hidden');
                                document.getElementById('dashboard-section').classList.remove('hidden');
                                document.getElementById('logout-btn').classList.remove('hidden');
                                fetchLogs();
                            } else {
                                window.location.href = '/admin';
                            }
                        } catch (err) {
                            // console.error("Auth check failed", err);
                            alert("Authentication check failed.");
                            auth.signOut();
                        }
                    } else {
                        document.getElementById('login-section').classList.remove('hidden');
                        document.getElementById('dashboard-section').classList.add('hidden');
                        document.getElementById('logout-btn').classList.add('hidden');
                    }
                });
            } catch (e) {
                // console.error(e);
                alert("Failed to initialize system.");
            }
        }

        // Login Handler
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            const errorMsg = document.getElementById('error-msg');
            const errorText = document.getElementById('error-text');

            try {
                // Set persistence based on checkbox (LOCAL = Remember Me, SESSION = Don't Remember)
                const persistence = rememberMe 
                    ? firebase.auth.Auth.Persistence.LOCAL 
                    : firebase.auth.Auth.Persistence.SESSION;
                
                await auth.setPersistence(persistence);
                await auth.signInWithEmailAndPassword(email, password);
                errorMsg.classList.add('hidden');
            } catch (error) {
                errorText.textContent = "Access Denied: " + error.message;
                errorMsg.classList.remove('hidden');
            }
        });

        // Logout Handler
        function logout() {
            auth.signOut();
        }

        // Fetch Logs
        async function fetchLogs() {
            const tbody = document.getElementById('logs-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="px-6 py-12 text-center">
                        <div class="flex flex-col items-center justify-center">
                            <i class="fa-solid fa-circle-notch fa-spin text-3xl text-teal-600 mb-3"></i>
                            <span class="text-gray-500 font-medium">Loading activity logs...</span>
                        </div>
                    </td>
                </tr>`;

            try {
                const token = await auth.currentUser.getIdToken();
                
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const search = document.getElementById('search-input').value.trim();
                const actionType = document.getElementById('action-filter').value;
                const userType = document.getElementById('user-type-filter').value;

                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (search) params.append('search', search);
                if (actionType) params.append('actionType', actionType);
                if (userType) params.append('userType', userType);

                const res = await fetch(`${API_BASE_URL}/api/logs?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.status === 403) {
                    throw new Error("Access Denied: You are not a Super Admin.");
                }

                if (!res.ok) throw new Error("Failed to fetch logs");
                
                const logs = await res.json();
                currentLogs = logs;
                currentPage = 1;
                renderLogs();
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
            }
        }

        function renderLogs() {
            const tbody = document.getElementById('logs-body');
            tbody.innerHTML = '';

            if (currentLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No activity recorded yet.</td></tr>';
                updatePaginationControls();
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const logsToShow = currentLogs.slice(start, end);

            logsToShow.forEach(log => {
                const row = document.createElement('tr');
                
                // Color code actions
                let actionClass = "text-gray-800";
                let bgClass = "";
                if (log.action === 'LOGIN') { actionClass = "text-green-600 font-bold"; bgClass = "bg-green-50"; }
                if (log.action === 'STUDENT_LOGIN') { actionClass = "text-teal-600 font-bold"; bgClass = "bg-teal-50"; }
                if (log.action === 'LOGOUT') { actionClass = "text-orange-600"; }
                if (log.action === 'ADD_STUDENT') { actionClass = "text-blue-600 font-bold"; bgClass = "bg-blue-50"; }
                if (log.action === 'DELETE_STUDENT') { actionClass = "text-red-600 font-bold"; bgClass = "bg-red-50"; }

                // Determine User Display
                let userName = log.instructorEmail || 'Unknown';
                let userId = log.instructorId || 'N/A';
                let userIcon = '<i class="fa-solid fa-user-tie text-gray-400 mr-1"></i>';

                if (log.userType === 'STUDENT') {
                    userName = log.studentName || 'Unknown Student';
                    userId = log.studentId || 'N/A';
                    userIcon = '<i class="fa-solid fa-graduation-cap text-gray-400 mr-1"></i>';
                }

                row.className = `hover:bg-gray-50 transition ${bgClass} cursor-pointer`;
                row.onclick = () => openLogModal(log);
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(log.timestamp).toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="font-medium">${userIcon} ${userName}</div>
                        <div class="text-xs text-gray-400">${userId}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${actionClass}">
                        ${log.action}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        ${log.details}
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePaginationControls();
        }

        function changePage(delta) {
            const totalPages = Math.ceil(currentLogs.length / itemsPerPage);
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderLogs();
            }
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(currentLogs.length / itemsPerPage) || 1;
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage === totalPages;
        }

        function openLogModal(log) {
            document.getElementById('modal-timestamp').textContent = new Date(log.timestamp).toLocaleString();
            document.getElementById('modal-action').textContent = log.action;
            document.getElementById('modal-details').textContent = log.details;
            
            if (log.userType === 'STUDENT') {
                document.getElementById('modal-instructor').textContent = log.studentName + " (Student)";
                document.getElementById('modal-instructor-id').textContent = log.studentId;
            } else {
                document.getElementById('modal-instructor').textContent = log.instructorEmail + " (Instructor)";
                document.getElementById('modal-instructor-id').textContent = log.instructorId;
            }
            
            document.getElementById('log-modal').classList.remove('hidden');
        }

        function closeLogModal() {
            document.getElementById('log-modal').classList.add('hidden');
        }

        function exportLogsToCSV() {
            if (!currentLogs || currentLogs.length === 0) {
                alert("No logs available to export.");
                return;
            }

            const headers = ["Timestamp", "User Type", "Name/Email", "ID", "Action", "Details"];
            const rows = [headers];

            currentLogs.forEach(log => {
                const escape = (val) => `"${(val || '').toString().replace(/"/g, '""')}"`;
                const isStudent = log.userType === 'STUDENT';
                const name = isStudent ? log.studentName : log.instructorEmail;
                const id = isStudent ? log.studentId : log.instructorId;

                rows.push([
                    escape(new Date(log.timestamp).toLocaleString()),
                    escape(log.userType || 'INSTRUCTOR'),
                    escape(name),
                    escape(id),
                    escape(log.action),
                    escape(log.details)
                ]);
            });

            const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `activity_logs_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function deleteOldLogs() {
            const dateStr = prompt("Delete logs older than (YYYY-MM-DD):");
            if (!dateStr) return;

            // Basic validation
            if (isNaN(new Date(dateStr).getTime())) {
                alert("Invalid date format.");
                return;
            }

            if (!confirm(`WARNING: This will permanently delete all activity logs created before ${dateStr}.\n\nAre you sure you want to proceed?`)) {
                return;
            }

            showLoading('Cleaning up logs...');
            try {
                const token = await auth.currentUser.getIdToken();
                const res = await fetch(`${API_BASE_URL}/api/logs?olderThan=${dateStr}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || "Failed to delete logs");
                }

                const data = await res.json();
                alert(`Cleanup Complete: ${data.deletedCount} logs deleted.`);
                fetchLogs(); // Refresh the table
            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                hideLoading();
            }
        }

        async function viewInstructors() {
            const tbody = document.getElementById('instructors-body');
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center">
                        <div class="flex flex-col items-center justify-center">
                            <i class="fa-solid fa-circle-notch fa-spin text-3xl text-teal-600 mb-3"></i>
                            <span class="text-gray-500 font-medium">Loading instructors...</span>
                        </div>
                    </td>
                </tr>`;
            document.getElementById('instructors-modal').classList.remove('hidden');

            try {
                const token = await auth.currentUser.getIdToken();
                const res = await fetch(`${API_BASE_URL}/api/instructors`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Failed to fetch instructors");
                const instructors = await res.json();
                
                tbody.innerHTML = '';
                if (instructors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No instructors found.</td></tr>';
                    return;
                }

                instructors.forEach(inst => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50";
                    
                    let statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-800">Active</span>';
                    let actionBtns = `<div class="flex gap-2">`;
                    
                    if (inst.disabled === true) {
                        statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-red-100 text-red-800">Banned</span>';
                        actionBtns += `<button onclick="toggleBan('${inst.instructorId}', false)" class="text-green-600 hover:text-green-900 text-xs font-bold border border-green-200 px-2 py-1 rounded hover:bg-green-50 transition cursor-pointer">UNBAN</button>`;
                    } else if (inst.disabled === null) {
                        statusBadge = '<span class="px-2 py-1 rounded text-xs font-bold bg-gray-100 text-gray-800">Deleted</span>';
                        actionBtns += '<span class="text-gray-400 text-xs">N/A</span>';
                    } else {
                        actionBtns += `<button onclick="toggleBan('${inst.instructorId}', true)" class="text-red-600 hover:text-red-900 text-xs font-bold border border-red-200 px-2 py-1 rounded hover:bg-red-50 transition cursor-pointer">BAN</button>`;
                    }

                    if (inst.disabled !== null) {
                        actionBtns += `<button onclick="resetPassword('${inst.instructorId}')" class="text-blue-600 hover:text-blue-900 text-xs font-bold border border-blue-200 px-2 py-1 rounded hover:bg-blue-50 transition cursor-pointer" title="Reset Password"><i class="fa-solid fa-key"></i></button>`;
                    }
                    actionBtns += `</div>`;

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${inst.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${inst.instructorId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(inst.lastLogin).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${actionBtns}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">Error: ${error.message}</td></tr>`;
            }
        }

        async function toggleBan(uid, shouldBan) {
            const action = shouldBan ? "BAN" : "UNBAN";
            if (!confirm(`Are you sure you want to ${action} this instructor?`)) return;

            showLoading(shouldBan ? 'Banning instructor...' : 'Unbanning instructor...');
            try {
                const token = await auth.currentUser.getIdToken();
                const res = await fetch(`${API_BASE_URL}/api/instructors/${uid}/status`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ disabled: shouldBan })
                });

                if (!res.ok) throw new Error("Failed to update status");
                
                // Refresh list
                viewInstructors();
                // Also refresh logs to see the action
                fetchLogs();
            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                hideLoading();
            }
        }

        async function resetPassword(uid) {
            if (!confirm("Generate a password reset link for this instructor?")) return;
            showLoading('Generating reset link...');
            try {
                const token = await auth.currentUser.getIdToken();
                const res = await fetch(`${API_BASE_URL}/api/instructors/${uid}/reset-password`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Failed to generate link");
                const data = await res.json();
                prompt("Copy this password reset link and send it to the instructor:", data.link);
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                hideLoading();
            }
        }

        function closeInstructorsModal() {
            document.getElementById('instructors-modal').classList.add('hidden');
        }

        // ================= DATABASE BACKUP/RESTORE =================
        async function backupDatabase() {
            showLoading('Preparing backup...');
            try {
                const token = await auth.currentUser.getIdToken();
                const res = await fetch(`${API_BASE_URL}/api/backup`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) throw new Error("Backup failed");
                
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                alert("Error creating backup: " + error.message);
            } finally {
                hideLoading();
            }
        }

        function triggerRestore() {
            document.getElementById('restore-file-input').click();
        }

        let pendingRestoreFile = null;
        let pendingRestoreInput = null;

        function restoreDatabase(input) {
            const file = input.files[0];
            if (!file) return;
            
            pendingRestoreFile = file;
            pendingRestoreInput = input;
            document.getElementById('restore-confirm-modal').classList.remove('hidden');
        }

        function closeRestoreModal() {
            document.getElementById('restore-confirm-modal').classList.add('hidden');
            if (pendingRestoreInput) {
                pendingRestoreInput.value = ''; 
            }
            pendingRestoreFile = null;
            pendingRestoreInput = null;
        }

        async function executeRestore() {
            const file = pendingRestoreFile;
            const input = pendingRestoreInput;
            
            document.getElementById('restore-confirm-modal').classList.add('hidden');
            
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                showLoading('Restoring database...');
                try {
                    const jsonContent = JSON.parse(e.target.result);
                    const token = await auth.currentUser.getIdToken();
                    
                    const res = await fetch(`${API_BASE_URL}/api/restore`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(jsonContent)
                    });

                    const result = await res.json();
                    if (!res.ok) throw new Error(result.error || "Restore failed");

                    alert("Success: " + result.message);
                    fetchLogs(); // Refresh logs to show potential changes or just to verify connection
                } catch (error) {
                    alert("Restore Error: " + error.message);
                } finally {
                    if (input) input.value = ''; 
                    hideLoading();
                    pendingRestoreFile = null;
                    pendingRestoreInput = null;
                }
            };
            reader.readAsText(file);
        }

        // Forgot Password Logic
        function openForgotModal() {
            const emailVal = document.getElementById('email').value;
            if(emailVal) document.getElementById('reset-email').value = emailVal;
            document.getElementById('reset-msg').classList.add('hidden');
            document.getElementById('forgot-password-modal').classList.remove('hidden');
        }

        function closeForgotModal() {
            document.getElementById('forgot-password-modal').classList.add('hidden');
        }

        function sendResetEmail() {
            const email = document.getElementById('reset-email').value;
            const msgEl = document.getElementById('reset-msg');
            
            if(!email) {
                msgEl.textContent = "Please enter an email address.";
                msgEl.className = "text-xs mb-4 block text-red-600";
                return;
            }

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    msgEl.textContent = "Reset link sent! Check your inbox.";
                    msgEl.className = "text-xs mb-4 block text-green-600";
                    setTimeout(closeForgotModal, 2000);
                })
                .catch((error) => {
                    msgEl.textContent = error.message;
                    msgEl.className = "text-xs mb-4 block text-red-600";
                });
        }

        // ================= GLOBAL SPINNER HELPERS =================
        function showLoading(text = 'Processing...') {
            document.getElementById('global-spinner-text').textContent = text;
            document.getElementById('global-spinner').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('global-spinner').classList.add('hidden');
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('password-toggle-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Allow pressing "Enter" in search box to trigger filter
        document.getElementById('search-input').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') fetchLogs();
        });

        // Initialize Firebase
        init();
    </script>
</body>
</html>